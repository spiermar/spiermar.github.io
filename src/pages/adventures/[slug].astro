---
/**
 * Adventure Detail Page
 *
 * Dynamic route for individual adventure pages. Displays full adventure details
 * including hero image, metadata, photo gallery links, and optional MDX content.
 *
 * Features:
 * - Static site generation via getStaticPaths()
 * - Hero image with 16:9 aspect ratio
 * - Adventure metadata (title, date, location)
 * - Status badge for planned adventures
 * - Gallery link button (if gallery URL provided)
 * - Individual images display (if images array provided)
 * - Optional MDX content rendering
 * - Responsive design for mobile and desktop
 *
 * Route: /adventures/[slug]
 *
 * @page
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';

/**
 * Static path generation for all adventures
 *
 * Generates a static page for each adventure in the content collection.
 * Each page receives the adventure entry as props for rendering.
 *
 * @returns Array of path objects with params and props
 */
export async function getStaticPaths() {
  const allAdventures = await getCollection('adventures');

  return allAdventures.map((adventure) => ({
    params: { slug: adventure.id },
    props: { adventure },
  }));
}

/**
 * Type definition for page props
 */
interface Props {
  adventure: CollectionEntry<'adventures'>;
}

/**
 * Extract adventure from props
 */
const { adventure } = Astro.props;

/**
 * Destructure adventure data for easier access
 */
const {
  title,
  location,
  date,
  coverImage,
  status,
  gallery,
  images,
} = adventure.data;

/**
 * Render MDX content if available
 *
 * Adventures can optionally include MDX content for additional details,
 * stories, or trip reports.
 */
const { Content } = await render(adventure);

/**
 * Format date for display
 *
 * Converts JavaScript Date to readable format (e.g., "January 15, 2024").
 */
const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

/**
 * Infer status from date if not explicitly set
 *
 * Adventures without an explicit status are considered 'completed' if in the past,
 * 'planned' if in the future.
 */
const actualStatus = status || (date > new Date() ? 'planned' : 'completed');
---

<BaseLayout>
  <SEO
    slot="head"
    title={title}
    description={`Adventure in ${location} on ${formattedDate}`}
    type="article"
  />

  <main class="adventure-detail">
    <!-- Hero Image Section -->
    <section class="hero-section">
      <div class="hero-image-container">
        <img
          src={coverImage}
          alt={title}
          class="hero-image"
          loading="eager"
        />
      </div>
    </section>

    <!-- Content Section -->
    <article class="adventure-content">
      <!-- Header -->
      <header class="adventure-header">
        <h1 class="adventure-title">{title}</h1>

        <div class="adventure-meta">
          <div class="meta-item">
            <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <time datetime={date.toISOString()}>{formattedDate}</time>
          </div>

          <div class="meta-item">
            <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span>{location}</span>
          </div>

          {actualStatus === 'planned' && (
            <span class="status-badge status-planned">Planned</span>
          )}
        </div>
      </header>

      <!-- Gallery Button (if gallery URL exists) -->
      {gallery && (
        <div class="gallery-section">
          <a
            href={gallery}
            target="_blank"
            rel="noopener noreferrer"
            class="gallery-button"
          >
            <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            View Full Gallery
            <svg class="external-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </a>
        </div>
      )}

      <!-- Individual Images (if images array exists) -->
      {images && images.length > 0 && (
        <div class="images-section">
          <h2 class="images-heading">Photos</h2>
          <div class="images-grid">
            {images.map((imageUrl) => (
              <div class="image-item">
                <img
                  src={imageUrl}
                  alt={`Photo from ${title}`}
                  class="grid-image"
                  loading="lazy"
                />
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- MDX Content (optional) -->
      {Content && (
        <div class="adventure-body">
          <Content />
        </div>
      )}
    </article>
  </main>

  <style>
    .adventure-detail {
      width: 100%;
      max-width: 100%;
    }

    /* Hero Section */
    .hero-section {
      width: 100%;
      margin-bottom: 2rem;
    }

    .hero-image-container {
      width: 100%;
      aspect-ratio: 16 / 9;
      overflow: hidden;
      background-color: var(--color-muted);
      border-radius: 0.5rem;
    }

    .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* Content Section */
    .adventure-content {
      max-width: 48rem;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Header */
    .adventure-header {
      margin-bottom: 2rem;
    }

    .adventure-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-text);
      margin: 0 0 1rem 0;
      line-height: 1.2;
    }

    .adventure-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      color: var(--color-text-secondary);
      font-size: 0.95rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .meta-icon {
      flex-shrink: 0;
      color: var(--color-text-secondary);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-planned {
      background-color: var(--color-accent-subtle);
      color: var(--color-accent);
    }

    /* Gallery Button */
    .gallery-section {
      margin-bottom: 2rem;
    }

    .gallery-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background-color: var(--color-accent);
      color: white;
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }

    .gallery-button:hover {
      background-color: var(--color-accent-hover);
    }

    .button-icon {
      flex-shrink: 0;
    }

    .external-icon {
      flex-shrink: 0;
      margin-left: 0.25rem;
    }

    /* Images Section */
    .images-section {
      margin-bottom: 2rem;
    }

    .images-heading {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 1.5rem 0;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .image-item {
      aspect-ratio: 4 / 3;
      overflow: hidden;
      background-color: var(--color-muted);
      border-radius: 0.5rem;
    }

    .grid-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }

    .image-item:hover .grid-image {
      transform: scale(1.05);
    }

    /* MDX Content */
    .adventure-body {
      margin-top: 2rem;
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--color-text);
    }

    .adventure-body :global(h2) {
      font-size: 1.75rem;
      font-weight: 600;
      margin: 2rem 0 1rem 0;
      color: var(--color-text);
    }

    .adventure-body :global(h3) {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 1.5rem 0 0.75rem 0;
      color: var(--color-text);
    }

    .adventure-body :global(p) {
      margin: 1rem 0;
    }

    .adventure-body :global(ul),
    .adventure-body :global(ol) {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    .adventure-body :global(li) {
      margin: 0.5rem 0;
    }

    .adventure-body :global(a) {
      color: var(--color-accent);
      text-decoration: underline;
    }

    .adventure-body :global(a:hover) {
      color: var(--color-accent-hover);
    }

    .adventure-body :global(code) {
      background-color: var(--color-muted);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.9em;
      font-family: monospace;
    }

    .adventure-body :global(pre) {
      background-color: var(--color-muted);
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1.5rem 0;
    }

    .adventure-body :global(pre code) {
      background-color: transparent;
      padding: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .adventure-title {
        font-size: 2rem;
      }

      .adventure-meta {
        gap: 1rem;
        font-size: 0.875rem;
      }

      .images-heading {
        font-size: 1.5rem;
      }

      .images-grid {
        grid-template-columns: 1fr;
      }

      .adventure-body {
        font-size: 1rem;
      }

      .adventure-body :global(h2) {
        font-size: 1.5rem;
      }

      .adventure-body :global(h3) {
        font-size: 1.25rem;
      }
    }
  </style>
</BaseLayout>
